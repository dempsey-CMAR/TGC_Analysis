---
title: 'TGC Model Manuscript: Update'
author: "Danielle Dempsey"
date: "`r Sys.Date()`"
output:
  html_document: default
editor_options:
  chunk_output_type: console
---
  
```{r, echo = FALSE, message=FALSE}

knitr::opts_chunk$set(echo = FALSE, fig.width=9, message=FALSE)

library(data.table)    # export example data
library(dplyr)         # data manipulation 
library(DT)            # interactive tables
library(ggplot2)       # figures
library(here)          # relative files paths
library(leaflet)       # interactive maps
library(strings)       # convert_depth_to_ordered_factor() function
library(tgc)           # season functions
library(sf)

dt_options <- list(
      dom = 'ft',
      paging = FALSE,
      searching = TRUE,
      scrollY = "500px",
      pageLength = 500,
      columnDefs = list(list(className = 'dt-center', targets = "_all"))
)

```

```{r}

# import data
dat_raw <- tibble(fread(here("data/TGC_temperature_data.csv"))) %>% 
  convert_depth_to_ordered_factor()

colour_pal <- get_colour_palette(dat_raw)

# lease shapefiles
leases <- read_sf(here("leases/geo_export_b4e7c4a6-0cc3-4654-a83f-835a2eeca93c.shp")) %>% 
  filter(county == "Halifax" | county == "Lunenburg" | county == "guysborough") %>% 
  st_transform(crs = "+proj=longlat +datum=WGS84")


```

Working title: Stocking size and growth time estimates of cultured Atlantic salmon (*Salmo salar*) under different coastal temperature regimens: guiding year-round and seasonal site selection

Co-authors (order to be discussed): Gregor Reid, Danielle Dempsey, Ryan Horricks, Leah Lewis-McCrea, Toby Balch, Andre Dumas, Jack Rensel, Roland Cusack

# Example Stations

The Thermal Growth Coefficient (TGC) model will be applied to temperature data from three of the Centre for Marine Applied Researchâ€™s (CMAR) sensor string stations.

The stations were selected based on:

  - Completeness of time series (e.g., no data gaps > 2 days)
  - Length of growing season (e.g., one "long" season ($\ge$ 12 months), one "medium" season (8 - 12 months), and one "short" season (< 8 months)
  - Temperature profile (e.g., stratification, number of depths with measurements)


## Locations

```{r}

rad <- 8
alpha <- 0.75

dat_map <- dat_raw %>% 
  select(STATION, LATITUDE, LONGITUDE) %>% 
  distinct(STATION, .keep_all = TRUE) %>% 
  mutate(
    SEASON_CLASS = case_when(
      STATION == "Rook Island" ~ "Short",
      STATION == "Madeline Point" |
        STATION == "East Gibbs Island" |
        STATION == "Beaver Point" ~ "Medium",
      STATION == "Birchy Head" ~ "Long"
    )
  )

leaflet(dat_map) %>%
  addProviderTiles(providers$CartoDB.Positron) %>%
  addPolygons(
    data = leases,
    color = "#444444", weight = 1, 
    label = ~license_le,
    labelOptions = labelOptions(permanent = FALSE),
    opacity = 1.0, fillOpacity = 0.5,
    highlightOptions = highlightOptions(
      color = "white", weight = 2, bringToFront = TRUE
    )
  ) %>% 
  addCircleMarkers(
    data = filter(dat_map, SEASON_CLASS == "Short"),
    ~LONGITUDE, ~LATITUDE, label = ~STATION,
    fillColor = "blue", stroke = FALSE, fillOpacity = alpha, radius = rad
  ) %>% 
  addCircleMarkers(
    data = filter(dat_map, SEASON_CLASS == "Medium"),
    ~LONGITUDE, ~LATITUDE, label = ~STATION,
    fillColor = "orange", stroke = FALSE, fillOpacity = alpha, radius = rad
  ) %>% 
  addCircleMarkers(
    data = filter(dat_map, SEASON_CLASS == "Long"),
    ~LONGITUDE, ~LATITUDE, label = ~STATION,
    fillColor = "red", stroke = FALSE, fillOpacity = alpha, radius = rad
  )

```
Figure 1: Stations selected to illustrate application of the TGC model - Birchy Head (red; long season), Beaver Point (yellow; medium season), Rook Island (blue; short season). Existing leases for Lunenburg, Halifax, and Guysborough counties shown in grey.

## All Data {.tabset}

These figures show all of the temperature data for each station. The TGC model will be applied to data for a single growing season (see next section).

Figure notes:

  - Red shading: heat stress (temperature $\ge$ 18 degrees Celsius)
  - Blue shading: superchill (temperature $\le$ -0.7 degrees Celsius)
  - Dashed grey line: 4 degrees Celsius

### Birchy Head

```{r}

dat_raw %>% 
  filter(STATION == "Birchy Head") %>% 
  plot_temperature_at_depth(
    colour_palette = colour_pal,
    date_labels_format = "%Y-%b"
  ) 

```

### Beaver Point

```{r}

dat_raw %>%
  filter(STATION == "Beaver Point") %>%
  plot_temperature_at_depth(
    colour_palette = colour_pal,
    date_labels_format = "%Y-%b"
  )

```

### Rook Island

```{r}

dat_raw %>%
  filter(STATION == "Rook Island") %>%
  plot_temperature_at_depth(
    colour_palette = colour_pal,
    date_labels_format = "%Y-%b"
  )

```


## Growing Season Data {.tabset}

  - The TGC model will be applied to the growing season beginning in 2018 for each depth at each station.
  - The growing season begins when the temperature exceeds 4 degrees Celsius and does not return below 4 degrees Celsius (e.g., "4-degrees trending up").
  - The growing season ends before the first observation of superchill.
  - If there is no superchill, the season is assumed to be 540 days (~ 18 months).
  - The "Season Table" tab shows the start and end date of the season, and the season duration in months for each depth/station.

```{r, message=FALSE, warning=FALSE}

dat_seasons <- st_filter_in_growing_seasons(dat_raw)

gap_table <- dat_seasons %>% 
  check_for_data_gaps(STATION, SEASON) %>% 
  group_by(STATION, SEASON, DEPTH) %>%
  summarize(TOTAL_GAP_DAYS = sum(GAP_LENGTH_DAYS)) %>%
  ungroup()

# data to plot
dat_seasons <- dat_seasons %>% 
  left_join(gap_table, by = c("STATION", "DEPTH", "SEASON")) %>% 
  filter(TOTAL_GAP_DAYS < 2) %>% 
  convert_depth_to_ordered_factor()

# summary table
seasons_table <- dat_seasons %>% 
  group_by(STATION, SEASON, DEPTH) %>% 
  summarise(START_SEASON = min(TIMESTAMP),
            END_SEASON = max(TIMESTAMP)) %>% 
  ungroup() %>% 
  mutate(
    SEASON_DAYS = difftime(END_SEASON, START_SEASON, units = "days"),
    SEASON_DAYS = as.numeric(round(SEASON_DAYS, digits = 2)),
    SEASON_MONTHS = round(SEASON_DAYS / 30, digits = 2)
  ) %>% 
  filter(SEASON != "S3") %>% 
  select(-SEASON, - SEASON_DAYS) %>% 
  arrange(STATION,  DEPTH)

```


### Birchy Head

```{r}

dat_seasons %>%
  filter(STATION == "Birchy Head" & SEASON == "S2") %>%
  plot_temperature_at_depth(
    colour_palette = colour_pal,
    date_breaks_major = "2 month",
    date_labels_format = "%Y-%b"
  )

```

### Beaver Point

```{r}

dat_seasons %>%
  filter(STATION == "Beaver Point" & SEASON == "S2") %>%
  plot_temperature_at_depth(
    colour_palette = colour_pal,
    date_breaks_major = "1 month",
    date_labels_format = "%Y-%b"
  )

```


### Rook Island

```{r}

dat_seasons %>%
  filter(STATION == "Rook Island") %>%
  plot_temperature_at_depth(
    colour_palette = colour_pal,
    date_breaks_major = "1 month",
    date_labels_format = "%Y-%b"
  )

```

### Season Table

```{r echo=FALSE}

seasons_table %>%
  mutate(START_SEASON = format(START_SEASON),
         END_SEASON = format(END_SEASON)) %>% 
  datatable(rownames = FALSE, options = dt_options)

```



## Next Step: Apply TGC Model

Apply TGC model at each example station and depth to answer the question:

What initial stocking weight is required to grow out a salmon to market size (5 kg) under these temperature conditions?


TGC model:

$$
w_0 = (w_t^{1/3} - \frac{TGC}{1000} * degreedays)^3
$$
$$degreedays = T_{Avg} * n_{days}$$

where

$w_0$ = initial stocking weight (kg)

$w_t$ = final weight after grow-out (kg)

$TGC$ = thermal growth coefficient (remedial = 0.25, average = 0.30, elite = 0.35)

$degreedays$ = degree days experienced by fish over growing season

$T_{Avg}$ = average temperature over the growing season*

$n_{days}$ = number of days in the growing season*

*Assume no growth for 24 hours after observation $\ge$ 18 degrees Celsius (observations in this window are removed and not included in $T_{Avg}$ or $n_{days}$)

